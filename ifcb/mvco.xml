<resolvers>
  <resolver name="all_series">
    <var name="ignore">
      <value>mvco,MVCO</value>
      <value>mvco_beads,beads</value>
      <value>Healy1101,Healy 1101</value>
      <value>saltpond,Salt Pond</value>
      <value>ditylum,Ditylum</value>
    </var>
    <match var="ignore" pattern="([^,]*),(.*)" groups="time_series name">
      <hit/>
    </match>
  </resolver>
  <resolver name="time_series">
    <var name="base_url">http://demi.whoi.edu/</var>
    <var name="namespace">${base_url}${time_series}/</var>
    <var name="bot_name">&lt;a href="/about"&gt;Imaging FlowCytobot&lt;a&gt;</var>
    <match var="time_series" value="mvco">
      <var name="title">${bot_name} @ &lt;a href="http://www.whoi.edu/mvco/"&gt;MVCO&lt;a&gt; 2006-present</var>
      <var name="dbname">ifcb</var>
      <hit/>
    </match>
    <match var="time_series" value="Healy1101">
      <var name="title">${bot_name} @ &lt;a href="http://www.espo.nasa.gov/icescape/"&gt;ICESCAPE-Healy1101&lt;a&gt;</var>
      <var name="dbname">healy1101</var>
      <hit/>
    </match>
    <match var="time_series" value="saltpond">
      <var name="title">${bot_name} @ Salt Pond</var>
      <var name="dbname">saltpond</var>
      <hit/>
    </match>
    <match var="time_series" value="ditylum">
      <var name="title">${bot_name} @ Olson lab</var>
      <var name="dbname">ditylum</var>
      <hit/>
    </match>
    <match var="time_series" value="mvco_beads">
      <var name="title">${bot_name}</var>
      <var name="dbname">mvco_beads</var>
      <hit/>
    </match>
  </resolver>
  <resolver name="pid">
    <match var="pid" groups="namespace time_series lid bin_lid instrument date yearday year day time - target - product - extension"
	   pattern="(.*?\b(\w+)?)/?(((IFCB\d+)_(((\d{4})_(\d{3}))_(\d{6})))(_(\d{5}))?)(_([a-zA-Z]\w+))?(\.([a-z][a-z0-9]*))?">
      <import name="time_series"/>
      <var name="date_format">%Y_%j_%H%M%S</var>
      <var name="schema_version">v1</var>
      <var name="bin_pid">${namespace}${bin_lid}</var>
      <hit/>
    </match>
    <match var="pid" groups="namespace time_series lid bin_lid date yearday year day time instrument - target - product - extension"
	   pattern="(.*?\b(\w+)?)/?((D(((\d{4})(\d{4}))T(\d{6}))_(IFCB\d+))(_(\d{5}))?)(_(\w+))?(\.(\w+))?">
      <import name="time_series"/>
      <var name="date_format">%Y%m%dT%H%M%S</var>
      <var name="schema_version">v2</var>
      <var name="bin_pid">${namespace}${bin_lid}</var>
      <hit/>
    </match>
  </resolver>
  <resolver name="data_roots">
    <!-- MVCO time series -->
    <match var="time_series" value="mvco">
      <match var="product" value="raw">
	<hit name="root">
	  <value>/data/vol3/adcmod</value> <!-- look here first, it shadows unmodified adc data -->
	  <value>/data/vol3</value>
	  <value>/data/vol1</value>
	  <value>/data/vol2</value>
	</hit>
      </match>
      <match var="product" pattern="blob.*">
	<hit name="root">/data/vol4/blobs</hit>
      </match>
      <match var="product" pattern="features">
	<hit name="root">
	  <value>/mnt/g_work_ifcb1/ifcb_data_mvco_jun06</value>
	</hit>
      </match>
      <match var="product" pattern="class_scores">
	<hit name="root">
	  <value>/mnt/g_work_ifcb1/ifcb_data_mvco_jun06</value>
	</hit>
      </match>
    </match>
    <!-- MVCO beads series -->
    <match var="time_series" value="mvco_beads">
      <match var="product" value="raw">
	<hit name="root">/data/vol1/beads</hit>
      </match>
      <match var="product" pattern="blob.*">
	<hit name="root">/data/vol4/blobs/mvco_beads</hit>
      </match>
    </match>
    <!-- Healy 1101 time series -->
    <match var="time_series" value="Healy1101">
      <match var="product" value="raw">
	<hit name="root">/mnt/healy1101/data</hit>
      </match>
      <match var="product" pattern="blob.*">
	<hit name="root">/mnt/healy1101/blobs</hit>
      </match>
    </match>
    <!-- Salt Pond time series -->
    <match var="time_series" value="saltpond">
      <match var="product" value="raw">
	<hit name="root">/mnt/saltpond</hit>
      </match>
      <match var="product" pattern="blob.*">
	<hit name="root">/data/vol4/blobs/saltpond</hit>
      </match>
    </match>
    <!-- Ditylum lab series -->
    <match var="time_series" value="ditylum">
      <match var="product" value="raw">
	<hit name="root">/mnt/rob2/proposals/NASA_2012/Ditylum_temperature/data</hit>
      </match>
      <match var="product" pattern="blob.*">
	<hit name="root">/data/vol4/blobs/ditylum</hit>
      </match>
    </match>
  </resolver>
  <resolver name="binpid2path">
    <!-- pid = pid of sample bin; format = adc,roi, or hdr -->
    <import name="pid"/>
    <var name="product">raw</var>
    <import name="data_roots"/>
    <var name="filename">
      <value>${lid}.${format}</value>
      <value>${lid}.${format}.mod</value>
    </var>
    <any>
      <path match="${root}/${instrument}_${year}_${day}/${filename}"/>
      <!-- in some cases there aren't year/day directories -->
      <path match="${root}/${filename}"/>
      <!-- try v2 patterns -->
      <path match="${root}/D${year}/D${year}${day}/${filename}"/>
    </any>
  </resolver>
  <resolver name="blobs">
    <import name="pid"/>
    <var name="product">blob</var>
    <import name="data_roots"/>
    <var name="filename">${bin_lid}_blobs_v2.zip</var>
    <hit>${root}/${year}/${yearday}/${filename}</hit>
  </resolver>
  <resolver name="mvco_blob">
    <import name="blobs"/>
    <path match="${value}"/>
  </resolver>
  <resolver name="features_destination">
    <import name="pid"/>
    <var name="product">features</var>
    <import name="data_roots"/>
    <hit>${root}/features${year}_v2/${lid}_fea_v2.csv</hit>
  </resolver>
  <resolver name="features">
    <import name="features_destination"/>
    <path match="${value}"/>
  </resolver>
  <resolver name="multiblob_destination">
    <import name="pid"/>
    <var name="product">features</var>
    <import name="data_roots"/>
    <hit>${root}/features${year}_v2/multiblob/${lid}_multiblob_v2.csv</hit>
  </resolver>
  <resolver name="multiblob">
    <import name="multiblob_destination"/>
    <path match="${value}"/>
  </resolver>
  <resolver name="class_scores_destination">
    <import name="pid"/>
    <var name="product">class_scores</var>
    <import name="data_roots"/>
    <hit>${root}/class${year}_v1/${lid}_class_v1.mat</hit>
  </resolver>
  <resolver name="class_scores">
    <import name="class_scores_destination"/>
    <path match="${value}"/>
  </resolver>
  <resolver name="list_day_dirs">
    <var name="product">raw</var>
    <import name="data_roots"/>
    <any>
      <path var="day_dir" match="${root}/D*/D*">
	<match var="day_dir" pattern=".*/D${year_pattern}.*"><hit/></match>
      </path>
      <path var="day_dir" match="${root}/IFCB*">
	<match var="day_dir" pattern=".*/IFCB._${year_pattern}.*"><hit/></match>
      </path>
      <!-- degenerate case: no day dirs -->
      <path var="day_dir" match="${root}"><hit/></path>
    </any>
  </resolver>
  <resolver name="list_adcs">
    <!-- list all adc files. -->
    <var name="product">raw</var>
    <import name="data_roots"/>
    <import name="list_day_dirs"/>
    <path var="adc_file" match="${day_dir}/*IFCB*.adc">
      <!-- extract 'pid' from adc pathname -->
      <match var="adc_file" groups="pid">.*/(.*)\..*</match>
      <import name="pid"/>
      <hit/>
    </path>
  </resolver>
  <resolver name="fileset">
    <!-- expects pid -->
    <first>
      <var name="format">roi</var>
      <import name="binpid2path"/>
      <var name="roi_path">${day_dir}/${filename}</var>
      <var name="format">hdr</var>
      <import name="binpid2path"/>
      <var name="hdr_path">${day_dir}/${filename}</var>
      <var name="format">adc</var>
      <import name="binpid2path"/>
      <var name="adc_path">${day_dir}/${filename}</var>
      <hit/>
    </first>
    <hit/>
  </resolver>
</resolvers>