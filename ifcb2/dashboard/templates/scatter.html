{% extends "master.html" %}
<!--
this Jinja template takes the following params:
- {{static}} - URL of static content
- {{endpoint}} - a JSON endpoint that returns ROI PID / x / y cols
- {{x_axis}} - x axis var
- {{y_axis}} - y axis var
- {{x_axis_label}} - x axis label
- {{y_axis_label}} - y axis label
-->
{% block head %}
  {{ super() }}
  <!-- flot -->
  <script type="text/javascript" src="{{static}}lib/flot/jquery.flot.js"></script>
  <script type="text/javascript" src="{{static}}lib/flot/jquery.flot.selection.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    // first, add features to static HTML
    $('#single_roi').closeBox().css('display','none');
    var plot_options = {
	series: {
	    points: {
		show: true,
		radius: 2,
	    }
	},
	grid: {
	    clickable: true,
	    hoverable: true,
	    autoHighlight: true
	},
	selection: {
	    mode: "xy",
	    color: "red"
	}
    };
    $("#scatter").append("Loading {{endpoint}} ..."); // FIXME
    var roi_pids = [];
    $('#title').empty().html('{{endpoint|safe}}');
    $.getJSON("{{endpoint}}", function(r) {
	console.log("Got JSON data");
	var point_data = [];
	$.each(r, function(ix, point) {
	    point_data.push([point.{{x_axis}}, point.{{y_axis}}]);
	    roi_pids.push(point.pid);
	});
	var plot_data = {
	    label: "{{x_axis_label}} x {{y_axis_label}}",
	    data: point_data,
	    color: "black",
	    points: {
		fillColor: "black"
	    },
	    highlightColor: "red"
	};
	$("#scatter").empty().plot([plot_data], plot_options);
    });
    $("#scatter").bind("plotselected", function(evt, ranges) {
	console.log(evt);
	$(evt.target).addClass("plotselected");
    });
    $("#scatter").bind("plotclick", function(evt, pos, item) {
	console.log(evt);
	if($(evt.target).hasClass("plotselected")) {
	    $(evt.target).removeClass("plotselected");
	    return;
	} else if(item) {
	    roi_pid = roi_pids[item.dataIndex];
	    // we found it. now determine ROI image dimensions by hitting the ROI endpoint
	    $.getJSON(roi_pid+'.json', function(r) {
		// use grayLoadingImage from image_pager to display the ROI
		var roi_width = r.height; // note that h/w is swapped (90 degrees rotated)
		var roi_height = r.width; // note that h/w is swapped (90 degrees rotated)
		$('#single_roi').empty()
		    .closeBox()
		    .css('display','inline-block')
		    .target_image(roi_pid, roi_width, roi_height)
		    .append('<br><div class="roi_info bin_label"></div>').find('.roi_info')
		    .append('<a href="'+roi_pid+'.html">'+roi_pid+'</a> ')
		    .append(' (<a href="'+roi_pid+'.xml">XML</a> ')
		    .append('<a href="'+roi_pid+'.rdf">RDF</a>)').end()
		    .append('<div><div class="target_metadata"></div></div>')
		    .find('.target_metadata')
		    .target_metadata(roi_pid)
		    .collapsing('metadata',false)
		    .end().css('float','right');
	    });
	}
    });
})
</script>
{% endblock head %}
{% block content %}
<div>
<div id="title" class="major h1"></div>
<div id="single_roi" class="major target_image"></div>
<div id="scatter" class="major" style="width:640px;height:480px"/>
</div>
<!-- end of content block FIXME debug -->
{% endblock content %}
