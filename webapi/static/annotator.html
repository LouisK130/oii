<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link type="text/css" href="css/smoothness/jquery-ui-1.8.14.custom.css" rel="Stylesheet" /> 
<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.14.custom.min.js"></script>
<script type="text/javascript" src="js/oii-utils.js"></script>
<title>image annotation prototype</title>
<style type="text/css">
div.thumbnail {
  display: inline-block;
  padding: 10px;
  vertical-align: top;
}
img.thumbnail {
  margin-left: auto;
  margin-right: auto;
}
.caption {
    text-align: center
}
.selected { background: #9999ff; }
</style>
<script type="text/javascript">
function gotoPage(page,size) {
    if(page < 1) page = 1;
    $.ajax({
        url: '/list_images',
        type: 'GET',
        data: {
            'offset': (page-1) * size,
            'limit': size
        },
        datatype: 'json',
        success: function(r,status) {
            clearPage();
            $.each(r, function(i,entry) {
                // append image with approprite URL
                image_url = entry.url;
                image_pid = entry.url; // for now, pid = url
                $('#images').append('<div class="thumbnail"><img src="'+image_url+'" class="thumbnail" height="300px"><div class="caption ui-widget">&nbsp;</div><div class="existing"></div></div>')
                	.find('div.thumbnail:last').data('image_pid',image_pid).hover(function(evt) {
                	    show_annotations(this);
                	}, function() { });
            });
        }
    });
}
function show_annotations(cell) {
    image_pid = $(cell).data('image_pid');
    $.ajax({
        url: '/list_annotations/image/' + image_pid,
        dataType: 'json',
        success: function(r) {
            $(cell).find('.existing').html(r.length+' annotation(s)');
        }
    });
}
function clearPage() {
    $('#images').empty();
}
function setLabel(cell,label) { /* cell = thumbnail div containing image */
    previousLabel = $(cell).data('previous-label');
    previousLabel = previousLabel == undefined ? '' : previousLabel;
    newLabel = $(cell).hasClass('selected') ? previousLabel : label;
    $(cell).data('previous-label',$(cell).data('label'));
    $(cell).find('div.caption').html(newLabel);
    $(cell).data('label',newLabel);
    $(cell).toggleClass('selected');
    $(cell).data('timestamp',iso8601(new Date()));
}
function revertLabel(cell) { /* cell = thumbnail div containing image */
    previousLabel = $(cell).data('previous-label');
    previousLabel = previousLabel == undefined ? '' : previousLabel;
    $(cell).data('previous-label','');
    $(cell).data('label',previousLabel);
    $(cell).find('div.caption').html(previousLabel);
    $(cell).removeClass('selected');
}
function preCommit() {
    /* generate an ID for each annotation */
    n = $('div.thumbnail.selected').length;
    /* FIXME hardcoded namespace */
    with_json_request('/generate_ids/'+n+'/http://foobar.ns/ann_', function(r) {
        $.each(r, function(i,id) {
            $('div.thumbnail.selected:eq('+i+')').data('annotation_pid',id);
        });
        commit();
    });
}
function commit() {
    var as = []
    $('div.thumbnail.selected').each(function() {
        ix = $(this).index();
        l = $(this).data('label');
        p = $(this).data('pid');
        a = {
                pid: $(this).data('annotation_pid'),
            	image: $(this).data('image_pid'),
            	timestamp: $(this).data('timestamp'),
            	annotator: 'http://people.net/joeblow',
            	taxon: $('#workspace').data('taxonomy')[$(this).data('label')],
            	boundingBox: [[0, 0], [0, 0]],
            };
        as.push(a)
        /*alert(a.image+' is a '+a.taxon+' at '+a.timestamp+', ann_id='+a.pid);*/
    });
    $.ajax({
        url: '/create_annotations',
        type: 'POST',
        contentType: 'json',
        dataType: 'json',
        data: JSON.stringify(as),
        success: function() {
            $('div.thumbnail').removeClass('selected');
        }
    });
}
function cancel() {
    $('div.thumbnail.selected').each(function(ix,cell) {
        revertLabel(cell);
    });
}
$(document).ready(function() {
    page = 1;
    size = 20;
    // inputs are ui widget styled
    $('input').addClass('ui-widget');
    // images div is not text-selectable
    $('#images').disableSelection(); // note that this is a jQuery UI function
    // thumbnail divs are selectable
    $('div.thumbnail').live('click',function() {
        setLabel($(this),$('#label').val());
    });
    // images are not draggable
    $('img').live('mousedown',function(event) {
        event.preventDefault();
    });
    $('a.button').button();
    $('#prev').click(function() {
        page--;
        if(page < 1) page = 1;
        gotoPage(page,25);
    });
    $('#next').click(function() {
        page++;
        gotoPage(page,25);
    });
	$('#workspace').data('taxonomy',{});
    $('#commit').click(function() {
		preCommit();
 	});
  	$('#cancel').click(function() {
  	  	cancel();
    });
    gotoPage(page,size);
    $('#label').autocomplete({
        source: function(req,resp) {
            with_json_request('/taxonomy_autocomplete?term='+req.term, function(r) {
            	resp($.map(r,function(item) {
            	    $('#workspace').data('taxonomy')[item.label] = item.pid;
            	    return {
            	        'label': item.label,
            	        'value': item.value
            	    }
            	}));
            });
        },
        minLength: 2
    });
});
</script>
</head>
<body>
<div id="workspace" style="display: none"></div>
<div id="controls" class="ui-widget">
  <a href="#" id="prev" class="button">&lt; Prev</a>
  <a href="#" id="next" class="button">Next &gt;</a>
  Class
  <input id="label"/>
  <a href="#" id="commit" class="button">Commit</a>
  <a href="#" id="cancel" class="button">Cancel</a>
</div>
<div id="images"></div>
</body>
</html>