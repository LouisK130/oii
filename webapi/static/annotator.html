<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link type="text/css" href="css/smoothness/jquery-ui-1.8.14.custom.css" rel="Stylesheet" /> 
<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.14.custom.min.js"></script>
<script type="text/javascript" src="js/oii-utils.js"></script>
<title>image annotation prototype</title>
<style type="text/css">
div.thumbnail {
  position: relative;
  display: inline-block;
  padding: 10px;
  vertical-align: top;
}
img.thumbnail {
  margin-left: auto;
  margin-right: auto;
}
.underlay {
  position: absolute;
  top: 10px;  /* thumbnail.div's padding */
  left: 10px;
}
.overlay {
  position: absolute;
  top: 10px;  /* thumbnail.div's padding */
  left: 10px;
}
.caption {
    text-align: center
}
.selected { background: #9999ff; }
</style>
<script type="text/javascript">
function gotoPage(page,size) {
    if(page < 1) page = 1;
    $.ajax({
        url: '/list_images',
        type: 'GET',
        data: {
            'offset': (page-1) * size,
            'limit': size
        },
        datatype: 'json',
        success: function(r,status) {
            clearPage();
            $.each(r, function(i,entry) {
                // append image with approprite URL
                var image_url = entry.url;
                var image_pid = entry.url; // for now, pid = url
                var cell = $('#images').append('<div class="thumbnail"><div class="spacer"></div><div class="caption ui-widget">&nbsp;</div><div class="existing"></div></div>')
                	.find('div.thumbnail:last')
                	.data('image_pid',image_pid)
                	.disableSelection();
                $(cell).prepend('<img style="display:none" src="'+image_url+'">')
                	.find('img')
                	.bind('load', {
                    cell: cell
                }, function() {
            		var iw = $(this).width();
            		var ih = $(this).height();
            		var scalingFactor = 0.33;
            		ih *= scalingFactor; /* we can apply arbitrary scaling factors here. */
            		iw *= scalingFactor;
            		$(cell).data('ox',-1);
            		$(cell).data('oy',-1);
            		$(cell).width(iw);
            		$(cell).find('div.spacer').height(ih+10);
            		ctx = $(cell).append('<canvas width="'+iw+'px" height="'+ih+'px" class="underlay"></canvas>')
            			.find('canvas.underlay')[0].getContext('2d');
            		ctx.drawImage(this, 0, 0, iw, ih);
            		$(cell).append('<canvas width="'+iw+'px" height="'+ih+'px" class="overlay"></canvas>')
            			.find('canvas.overlay').mousedown(function(event) {
            				var mx = event.pageX - $(this).offset().left;
                			var my = event.pageY - $(this).offset().top;
                			$(cell).data('ox',mx); /* FIXME generalize to arbitrary geometries */
                			$(cell).data('oy',my);
            			}).mousemove(function(event) {
            			    var ox = $(cell).data('ox');
            			    var oy = $(cell).data('oy');
            			    if(ox >= 0 && oy >= 0) {
              					var mx = event.pageX - $(this).offset().left;
                				var my = event.pageY - $(this).offset().top;
            				    ctx = $(this)[0].getContext('2d');
            				    ctx.clearRect(0,0,iw,ih);
            				    ctx.strokeStyle = '#0f0';
            					var left = Math.min(ox,mx);
            					var top = Math.min(oy,my);
            					var w = Math.max(ox,mx) - left;
            					var h = Math.max(oy,my) - top;
            					var rect = [left, top, left+w, top+h]
            					$(cell).data('rect',rect);
            					$('#coords').html('drawing rect at '+rect);
            		        	ctx.strokeRect(left, top, w, h);
            			    }
            			}).bind('mouseup', {
            			    cell: cell
            			}, function(event) {
            			    var rect = $(cell).data('rect'); 
            			    $('#coords').html('marked '+rect+' as '+$('#label').val()+' for '+cell);
            			    $(cell).data('ox',-1);
            			    $(cell).data('oy',-1);
            			    toggleSelected(cell);
            			});
                });
            });
        }
    });
}
function show_annotations(cell) {
    image_pid = $(cell).data('image_pid');
    $.ajax({
        url: '/list_annotations/image/' + image_pid,
        dataType: 'json',
        success: function(r) {
            $(cell).find('.existing').html(r.length+' annotation(s)');
        }
    });
}
function clearPage() {
    $('#images').empty();
}
function setLabel(cell,label) {
    /* first convert undefined to '' */
    var previousLabel = $(cell).data('previous-label');
    previousLabel = previousLabel == undefined ? '' : previousLabel;
    $(cell).data('previous-label',previousLabel);
    /* now swap */
    $(cell).data('previous-label',$(cell).data('label'));
    $(cell).data('label',label);
    var p = $(cell).data('previous-label');
    $(cell).find('div.caption').html(label);
}
function unsetLabel(cell) {
    setLabel(cell,$(cell).data('previous-label'));
}
function toggleSelected(cell) { /* cell = thumbnail div containing image */
    if($(cell).hasClass('selected')) {
        /* deselect */
		unsetLabel(cell);
        $(cell).removeClass('selected');
    } else {
        /* select */
        setLabel(cell,$('#label').val());
        $(cell).data('timestamp',iso8601(new Date()));
        $(cell).addClass('selected');
    }
}
function preCommit() {
    /* generate an ID for each annotation */
    n = $('div.thumbnail.selected').length;
    /* FIXME hardcoded namespace */
    with_json_request('/generate_ids/'+n+'/http://foobar.ns/ann_', function(r) {
        $.each(r, function(i,id) {
            $('div.thumbnail.selected:eq('+i+')').data('annotation_pid',id);
        });
        commit();
    });
}
function commit() {
    var as = []
    $('div.thumbnail.selected').each(function() {
        ix = $(this).index();
        l = $(this).data('label');
        p = $(this).data('pid');
        a = {
                pid: $(this).data('annotation_pid'),
            	image: $(this).data('image_pid'),
            	timestamp: $(this).data('timestamp'),
            	annotator: 'http://people.net/joeblow',
            	category: $('#workspace').data('taxonomy')[$(this).data('label')],
            	geometry: { boundingBox: $(this).data('rect') }
            };
        as.push(a)
        /*alert(a.image+' is a '+a.category+' at '+a.timestamp+', ann_id='+a.pid);*/
    });
    $.ajax({
        url: '/create_annotations',
        type: 'POST',
        contentType: 'json',
        dataType: 'json',
        data: JSON.stringify(as),
        success: function() {
            $('div.thumbnail').removeClass('selected');
        }
    });
}
function cancel() {
    $('div.thumbnail.selected').each(function(ix,cell) {
        toggledSelected(cell);
    });
}
$(document).ready(function() {
    page = 1;
    size = 20;
    // inputs are ui widget styled
    $('input').addClass('ui-widget');
    // images div is not text-selectable
    $('#images').disableSelection(); // note that this is a jQuery UI function
    // images are not draggable
    $('img').live('mousedown',function(event) {
        event.preventDefault();
    });
    $('a.button').button();
    $('#prev').click(function() {
        page--;
        if(page < 1) page = 1;
        gotoPage(page,25);
    });
    $('#next').click(function() {
        page++;
        gotoPage(page,25);
    });
	$('#workspace').data('taxonomy',{});
    $('#commit').click(function() {
		preCommit();
 	});
  	$('#cancel').click(function() {
  	  	cancel();
    });
    gotoPage(page,size);
    $('#label').autocomplete({
        source: function(req,resp) {
            with_json_request('/taxonomy_autocomplete?term='+req.term, function(r) {
            	resp($.map(r,function(item) {
            	    $('#workspace').data('taxonomy')[item.label] = item.pid;
            	    return {
            	        'label': item.label,
            	        'value': item.value
            	    }
            	}));
            });
        },
        minLength: 2
    });
});
</script>
</head>
<body>
<div id="workspace" style="display: none"></div>
<div id="coords">hello</div>
<div id="controls" class="ui-widget">
  <a href="#" id="prev" class="button">&lt; Prev</a>
  <a href="#" id="next" class="button">Next &gt;</a>
  Class
  <input id="label"/>
  <a href="#" id="commit" class="button">Commit</a>
  <a href="#" id="cancel" class="button">Cancel</a>
</div>
<div id="images"></div>
</body>
</html>